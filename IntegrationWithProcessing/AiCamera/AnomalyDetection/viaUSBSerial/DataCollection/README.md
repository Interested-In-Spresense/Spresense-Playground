# Anomaly Detection用 データ収集サンプル

Spresense カメラモジュールとProcessingを使用して、機械学習（Anomaly Detection）用の教師画像（64x48ピクセル）を撮影・保存するサンプルです。

## 概要

このプロジェクトは、Spresenseで撮影した映像をリアルタイムでProcessingに表示しながら、必要なタイミングでキー操作により教師データ用の画像を連番で保存できるサンプルです。
64x48ピクセル画像を5x5ブロック平均でリサイズすることで、エッジデバイス向けの機械学習モデルに適したデータセットを効率的に作成できます。

## 特徴

- **機械学習向け**: 64x48ピクセルの小型画像でエッジデバイスでの推論に最適
- **リアルタイムプレビュー**: 撮影対象をProcessingでリアルタイム確認
- **簡単操作**: キーを押すだけで連番保存（data/0000.png～）
- **カラー/グレースケール対応**: 用途に応じて切り替え可能

## ハードウェア要件

- Spresense メインボード
- Spresense 拡張ボード
- Spresense カメラモジュール
- USBケーブル（データ転送用）


## ファイル構成

```
Spresene/
├── Spresense.ino      # Spresense メインプログラム
├── ResizeYUV422.h     # YUV422リサイズ関数ヘッダー
├── ResizeYUV422.cpp   # YUV422リサイズ実装（5x5ブロック平均）

Processing/
└── Processing.pde     # Processing表示・保存プログラム

README.md                 # このファイル

```

## 使い方

### 1. セットアップ

#### Spresense側
1. Arduino IDEで`Spresense.ino`を開く
2. Spresenseボードを選択し、コンパイル・アップロード
3. カメラモジュールを接続

#### Processing側
1. Processingで`SProcessing.pde`を開く
2. シリアルポート名を確認・設定（`SERIAL_PORTNAME`）
3. 実行

### 2. 教師画像の撮影手順

1. **準備**
   - Spresenseとカメラを設置
   - Processingを起動してリアルタイムプレビューを表示
   - 照明や背景を確認

2. **撮影モード選択**
   - `g`キー: グレースケールモード（デフォルト）
   - `c`キー: カラーモード
   - 画面とコンソールでモードを確認

3. **撮影・保存**
   - 被写体をカメラの前に配置
   - プレビューで構図を確認
   - `s`キーで撮影・保存
   - `data/0000.png`, `0001.png`...と自動で連番保存

4. **データセット作成**
   - 異なる角度・位置・照明で複数枚撮影
   - クラスごとにフォルダを分けて整理
   - 必要な枚数だけ繰り返し

### 3. キー操作一覧

| キー | 機能 |
|------|------|
| `g` | グレースケールモードに切り替え |
| `c` | カラーモードに切り替え |
| `s` | 現在のモードでPNG保存 |

### 4. 保存データの活用

保存された画像は以下のように使用できます：

```
SnapshotCamera_Processing/data/
├── 0000.png  (64x48 グレースケール or カラー)
├── 0001.png
├── 0002.png
...
```

## 技術仕様

### 画像処理

- **キャプチャ解像度**: 320x240 (QVGA)
- **出力解像度**: 64x48（機械学習に適したサイズ）
- **色空間**: YUV422 (UYVY形式)
- **リサイズ方式**: 5x5ブロック平均（高品質、情報損失を最小化）
- **フレームレート**: 約10fps
- **データ形式**: PNG（可逆圧縮）

### 機械学習への適用

**データセット作成のコツ:**
- クラスごとに100枚以上撮影を推奨
- 照明条件を変えて撮影（明るい/暗い）
- 角度を変えて撮影（正面/斜め/横）
- 背景を変えて撮影（汎化性能向上）
- Data Augmentationと併用してデータ量を増やす

### 通信プロトコル

**フレーム構造:**
```
[Header] 'SPRS' (4 bytes)
[Size] データサイズ (4 bytes, ビッグエンディアン)
[Data] YUV422データ (6144 bytes = 64×48×2)
[Footer] 'ENDS' (4 bytes)
```

**シリアル設定:**
- ボーレート: 921600 bps
- データビット: 8
- パリティ: なし
- ストップビット: 1

### YUV422フォーマット

UYVY形式（Spresense標準）:
```
[U0 Y0 V0 Y1] [U2 Y2 V2 Y3] ...
```

- グレースケール: Y成分のみ使用
- カラー: YUV→RGB変換（BT.601係数）

## トラブルシューティング

### 画像が表示されない

1. シリアルポート名を確認（Processing側のSERIAL_PORTNAME）
2. Spresenseが正しく接続されているか確認
3. Arduino IDEのシリアルモニタでエラーメッセージを確認

### フレームが途切れる

- "recover3"などのメッセージが出る場合: 正常動作（バッファ同期処理）
- 頻繁に出る場合: USBケーブルを変更するか、PCの負荷を下げる

### 画像が乱れる

- カメラレンズの汚れを確認
- 照明条件を改善
- フォーカス調整（カメラモジュールによる）

